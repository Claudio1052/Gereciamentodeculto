<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Verbo da Vida - ZL</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .active-tab { background-color: #2563eb; color: white; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-white shadow-lg hidden md:flex flex-col z-10">
        <div class="h-24 flex flex-col items-center justify-center border-b border-gray-200 bg-blue-800 text-white">
            <h1 class="text-xl font-bold">VERBO DA VIDA</h1>
            <p class="text-xs opacity-75">ZONA LESTE</p>
        </div>
        <nav class="flex-1 py-4 space-y-2">
            <button onclick="navegar('dashboard')" id="nav-dashboard" class="w-full text-left px-6 py-3 hover:bg-gray-100 text-gray-700 font-medium transition active-tab">
                <i class="fas fa-chart-pie mr-3 w-6"></i> Dashboard
            </button>
            <button onclick="navegar('cultos')" id="nav-cultos" class="w-full text-left px-6 py-3 hover:bg-gray-100 text-gray-700 font-medium transition">
                <i class="fas fa-church mr-3 w-6"></i> Gerenciar Cultos
            </button>
            <button onclick="navegar('membros')" id="nav-membros" class="w-full text-left px-6 py-3 hover:bg-gray-100 text-gray-700 font-medium transition">
                <i class="fas fa-users mr-3 w-6"></i> Membros
            </button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-y-auto bg-gray-100">
        <header class="md:hidden bg-blue-800 text-white h-16 shadow flex items-center justify-between px-4">
            <span class="font-bold">Verbo ZL</span>
            <button class="text-white"><i class="fas fa-bars"></i></button>
        </header>

        <div class="p-4 md:p-8 pb-20">
            
            <div id="view-dashboard" class="fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Visão Geral</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-5 rounded shadow border-l-4 border-blue-600">
                        <p class="text-gray-500 text-sm">Total de Membros</p>
                        <p class="text-3xl font-bold" id="d-total-membros">-</p>
                    </div>
                    <div class="bg-white p-5 rounded shadow border-l-4 border-green-600">
                        <p class="text-gray-500 text-sm">Média de Público</p>
                        <p class="text-3xl font-bold" id="d-media-publico">-</p>
                    </div>
                    <div class="bg-white p-5 rounded shadow border-l-4 border-orange-500">
                        <p class="text-gray-500 text-sm">Aniversariantes (Mês)</p>
                        <p class="text-3xl font-bold" id="d-aniversariantes">-</p>
                    </div>
                    <div class="bg-white p-5 rounded shadow border-l-4 border-purple-600">
                        <p class="text-gray-500 text-sm">Graduados Rhema</p>
                        <p class="text-3xl font-bold" id="d-rhema">-</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded shadow">
                        <h4 class="font-bold text-gray-700 mb-2">Frequência (Últimos Cultos)</h4>
                        <canvas id="graficoLinha"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded shadow">
                        <h4 class="font-bold text-gray-700 mb-2">Público (Homens x Mulheres x Crianças)</h4>
                        <div class="h-64 flex justify-center">
                            <canvas id="graficoPizza"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-cultos" class="hidden fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Gerenciar Cultos</h2>
                
                <div class="bg-white p-6 rounded shadow mb-8">
                    <h3 class="font-bold text-blue-800 mb-4">Adicionar Relatório</h3>
                    <form id="formCulto" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="date" id="c-data" required class="p-2 border rounded">
                        <input type="time" id="c-inicio" required class="p-2 border rounded">
                        <input type="time" id="c-fim" required class="p-2 border rounded">
                        <input type="text" id="c-ministro" placeholder="Ministro" class="p-2 border rounded">
                        
                        <input type="text" id="c-dirigente" placeholder="Dirigente" class="p-2 border rounded">
                        <input type="number" id="c-tempomin" placeholder="Minutos Ministração" class="p-2 border rounded">
                        <input type="number" id="c-tempodir" placeholder="Minutos Dirigente" class="p-2 border rounded">
                        <div class="md:col-span-1"></div>

                        <div class="md:col-span-4 flex gap-4 bg-gray-50 p-3 rounded border">
                            <div class="flex-1">
                                <label class="text-xs">Homens</label>
                                <input type="number" id="c-homens" value="0" class="w-full border p-1 rounded">
                            </div>
                            <div class="flex-1">
                                <label class="text-xs">Mulheres</label>
                                <input type="number" id="c-mulheres" value="0" class="w-full border p-1 rounded">
                            </div>
                            <div class="flex-1">
                                <label class="text-xs">Crianças</label>
                                <input type="number" id="c-criancas" value="0" class="w-full border p-1 rounded">
                            </div>
                        </div>

                        <button type="button" onclick="salvarCulto()" class="md:col-span-4 bg-blue-700 text-white py-2 rounded font-bold hover:bg-blue-800">
                            SALVAR CULTO
                        </button>
                    </form>
                </div>

                <div class="bg-white rounded shadow overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-700 uppercase">
                            <tr>
                                <th class="px-4 py-3">Data</th>
                                <th class="px-4 py-3">Ministro</th>
                                <th class="px-4 py-3">Total Pessoas</th>
                                <th class="px-4 py-3">Tempo Palavra</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-cultos"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-membros" class="hidden fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Gerenciar Membros</h2>

                <div class="flex gap-2 mb-4">
                    <button onclick="carregarMembros(true)" class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700">
                        <i class="fas fa-birthday-cake"></i> Aniversariantes do Mês
                    </button>
                    <button onclick="carregarMembros(false)" class="bg-gray-500 text-white px-4 py-2 rounded text-sm hover:bg-gray-600">
                        Todos
                    </button>
                </div>

                <div class="bg-white p-6 rounded shadow mb-8">
                    <h3 class="font-bold text-blue-800 mb-4">Novo Membro</h3>
                    <form id="formMembro" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="m-nome" placeholder="Nome Completo" required class="p-2 border rounded md:col-span-2">
                        <input type="date" id="m-nasc" required class="p-2 border rounded">
                        <input type="text" id="m-tel" placeholder="Telefone" class="p-2 border rounded">
                        
                        <div class="flex gap-1">
                            <input type="text" id="m-cep" placeholder="CEP" class="p-2 border rounded w-full">
                            <button type="button" onclick="buscarCep()" class="bg-gray-200 px-3 rounded"><i class="fas fa-search"></i></button>
                        </div>
                        
                        <input type="text" id="m-end" placeholder="Endereço" class="p-2 border rounded">
                        <input type="text" id="m-num" placeholder="Número" class="p-2 border rounded">
                        <input type="text" id="m-bairro" placeholder="Bairro" class="p-2 border rounded">
                        <input type="text" id="m-cidade" placeholder="Cidade" class="p-2 border rounded bg-gray-50">
                        <input type="text" id="m-uf" placeholder="UF" class="p-2 border rounded bg-gray-50">

                        <div class="md:col-span-3 flex gap-4 p-2 bg-gray-50">
                            <label class="flex items-center gap-2"><input type="checkbox" id="check-rhema"> Fez Rhema</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="check-ministros"> Escola Ministros</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="check-missoes"> Escola Missões</label>
                        </div>

                        <button type="button" onclick="salvarMembro()" class="md:col-span-3 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">
                            CADASTRAR MEMBRO
                        </button>
                    </form>
                </div>

                <div class="bg-white rounded shadow overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-700 uppercase">
                            <tr>
                                <th class="px-4 py-3">Nome</th>
                                <th class="px-4 py-3">Telefone</th>
                                <th class="px-4 py-3">Bairro</th>
                                <th class="px-4 py-3 text-center">Rhema</th>
                                <th class="px-4 py-3">Aniversário</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-membros"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <script>
        // 1. CONFIGURAÇÃO DO BANCO (Credenciais inseridas)
        const SB_URL = 'https://nekbbkenxcukoortusge.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5la2Jia2VueGN1a29vcnR1c2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTU5MDIsImV4cCI6MjA3ODk3MTkwMn0.D72914Vyz1du1ZDKoNDdwT7YI-D8WPgZe38LbBV2bfc';
        
        // Inicializa o cliente do Supabase
        let supabase;
        try {
            const { createClient } = window.supabase;
            supabase = createClient(SB_URL, SB_KEY);
            console.log("Supabase iniciado com sucesso");
        } catch (error) {
            alert("Erro crítico: A biblioteca Supabase não carregou. Verifique sua internet.");
            console.error(error);
        }

        // 2. SISTEMA DE NAVEGAÇÃO (Abas)
        function navegar(aba) {
            // Esconde tudo
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-cultos').classList.add('hidden');
            document.getElementById('view-membros').classList.add('hidden');
            
            // Remove cor dos botões
            document.getElementById('nav-dashboard').classList.remove('active-tab');
            document.getElementById('nav-cultos').classList.remove('active-tab');
            document.getElementById('nav-membros').classList.remove('active-tab');

            // Mostra a aba certa
            document.getElementById('view-' + aba).classList.remove('hidden');
            document.getElementById('nav-' + aba).classList.add('active-tab');

            // Recarrega dados
            if(aba === 'dashboard') carregarDashboard();
            if(aba === 'cultos') carregarCultos();
            if(aba === 'membros') carregarMembros(false);
        }

        // 3. FUNÇÕES: MEMBROS
        async function buscarCep() {
            const cep = document.getElementById('m-cep').value.replace(/\D/g, '');
            if(cep.length !== 8) return alert("CEP inválido");
            
            try {
                const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await res.json();
                if(data.erro) throw new Error();
                
                document.getElementById('m-end').value = data.logradouro;
                document.getElementById('m-bairro').value = data.bairro;
                document.getElementById('m-cidade').value = data.localidade;
                document.getElementById('m-uf').value = data.uf;
                document.getElementById('m-num').focus();
            } catch (e) {
                alert("CEP não encontrado!");
            }
        }

        async function salvarMembro() {
            const dados = {
                nome: document.getElementById('m-nome').value,
                data_nascimento: document.getElementById('m-nasc').value,
                telefone: document.getElementById('m-tel').value,
                cep: document.getElementById('m-cep').value,
                endereco: document.getElementById('m-end').value,
                numero: document.getElementById('m-num').value,
                bairro: document.getElementById('m-bairro').value,
                cidade: document.getElementById('m-cidade').value,
                uf: document.getElementById('m-uf').value,
                fez_rhema: document.getElementById('check-rhema').checked,
                fez_escola_ministros: document.getElementById('check-ministros').checked,
                fez_escola_missoes: document.getElementById('check-missoes').checked
            };

            if(!dados.nome || !dados.data_nascimento) return alert("Preencha Nome e Data de Nascimento!");

            const { error } = await supabase.from('membros').insert([dados]);
            
            if(error) {
                alert("Erro ao salvar: " + error.message);
                console.error(error);
            } else {
                alert("Membro cadastrado com glória!");
                document.getElementById('formMembro').reset();
                carregarMembros(false);
            }
        }

        async function carregarMembros(somenteAniversariantes) {
            const { data, error } = await supabase.from('membros').select('*').order('nome');
            if(error) return console.error(error);

            const tbody = document.getElementById('tabela-membros');
            tbody.innerHTML = '';

            const mesAtual = new Date().getMonth(); // 0 a 11

            data.forEach(m => {
                const dataNasc = new Date(m.data_nascimento); // Objeto Data
                const dia = dataNasc.getUTCDate();
                const mes = dataNasc.getUTCMonth();
                
                // Filtro
                if(somenteAniversariantes && mes !== mesAtual) return;

                tbody.innerHTML += `
                    <tr class="bg-white border-b hover:bg-blue-50">
                        <td class="px-4 py-3 font-bold text-gray-800">${m.nome}</td>
                        <td class="px-4 py-3">${m.telefone || '-'}</td>
                        <td class="px-4 py-3">${m.bairro || '-'}</td>
                        <td class="px-4 py-3 text-center">${m.fez_rhema ? '<i class="fas fa-check text-green-600"></i>' : ''}</td>
                        <td class="px-4 py-3 text-center">${dia}/${mes + 1}</td>
                    </tr>
                `;
            });
        }

        // 4. FUNÇÕES: CULTOS
        async function salvarCulto() {
            const dados = {
                data_culto: document.getElementById('c-data').value,
                horario_inicio: document.getElementById('c-inicio').value,
                horario_termino: document.getElementById('c-fim').value,
                ministro: document.getElementById('c-ministro').value,
                dirigente: document.getElementById('c-dirigente').value,
                tempo_ministracao: document.getElementById('c-tempomin').value,
                tempo_dirigente: document.getElementById('c-tempodir').value,
                qtd_homens: parseInt(document.getElementById('c-homens').value) || 0,
                qtd_mulheres: parseInt(document.getElementById('c-mulheres').value) || 0,
                qtd_criancas: parseInt(document.getElementById('c-criancas').value) || 0
            };

            if(!dados.data_culto) return alert("Informe a data do culto!");

            const { error } = await supabase.from('cultos').insert([dados]);

            if(error) {
                alert("Erro ao salvar culto: " + error.message);
            } else {
                alert("Relatório salvo com sucesso!");
                document.getElementById('formCulto').reset();
                carregarCultos();
            }
        }

        async function carregarCultos() {
            const { data, error } = await supabase.from('cultos').select('*').order('data_culto', { ascending: false });
            if(error) return console.error(error);

            const tbody = document.getElementById('tabela-cultos');
            tbody.innerHTML = '';

            data.forEach(c => {
                const total = (c.qtd_homens || 0) + (c.qtd_mulheres || 0) + (c.qtd_criancas || 0);
                const dataFormatada = c.data_culto.split('-').reverse().join('/');
                
                tbody.innerHTML += `
                    <tr class="bg-white border-b hover:bg-blue-50">
                        <td class="px-4 py-3 font-medium">${dataFormatada}</td>
                        <td class="px-4 py-3">${c.ministro}</td>
                        <td class="px-4 py-3 font-bold text-blue-800">${total}</td>
                        <td class="px-4 py-3">${c.tempo_ministracao || 0} min</td>
                    </tr>
                `;
            });
        }

        // 5. DASHBOARD
        let chartLinha = null;
        let chartPizza = null;

        async function carregarDashboard() {
            // Puxa Membros
            const { data: membros } = await supabase.from('membros').select('*');
            // Puxa Cultos
            const { data: cultos } = await supabase.from('cultos').select('*').order('data_culto', { ascending: true });

            if(!membros || !cultos) return;

            // KPIs
            document.getElementById('d-total-membros').innerText = membros.length;
            document.getElementById('d-rhema').innerText = membros.filter(m => m.fez_rhema).length;
            
            const mesAtual = new Date().getUTCMonth();
            const niverMes = membros.filter(m => new Date(m.data_nascimento).getUTCMonth() === mesAtual).length;
            document.getElementById('d-aniversariantes').innerText = niverMes;

            // Cálculos para Gráficos
            let totalGeral = 0, somaHomens = 0, somaMulheres = 0, somaCriancas = 0;
            const labelsDatas = [];
            const dadosFrequencia = [];

            cultos.forEach(c => {
                const total = (c.qtd_homens || 0) + (c.qtd_mulheres || 0) + (c.qtd_criancas || 0);
                totalGeral += total;
                somaHomens += c.qtd_homens || 0;
                somaMulheres += c.qtd_mulheres || 0;
                somaCriancas += c.qtd_criancas || 0;

                labelsDatas.push(c.data_culto.split('-').reverse().slice(0,2).join('/')); // DD/MM
                dadosFrequencia.push(total);
            });

            document.getElementById('d-media-publico').innerText = cultos.length ? Math.round(totalGeral / cultos.length) : 0;

            // Gráfico Linha
            const ctx1 = document.getElementById('graficoLinha').getContext('2d');
            if(chartLinha) chartLinha.destroy();
            chartLinha = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labelsDatas.slice(-10),
                    datasets: [{
                        label: 'Pessoas',
                        data: dadosFrequencia.slice(-10),
                        borderColor: '#2563eb',
                        tension: 0.3,
                        fill: true
                    }]
                }
            });

            // Gráfico Pizza
            const ctx2 = document.getElementById('graficoPizza').getContext('2d');
            if(chartPizza) chartPizza.destroy();
            if(cultos.length > 0) {
                chartPizza = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Homens', 'Mulheres', 'Crianças'],
                        datasets: [{
                            data: [somaHomens, somaMulheres, somaCriancas],
                            backgroundColor: ['#3b82f6', '#ec4899', '#f59e0b']
                        }]
                    }
                });
            }
        }

        // Inicializa no Dashboard
        navegar('dashboard');
        // Teste de conexão visual
        setTimeout(() => {
            if(!supabase) alert("Atenção: Falha na conexão com Supabase.");
        }, 2000);

    </script>
</body>
</html>
