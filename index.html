<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IEVV Zona Leste - Sistema</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { background: #f4f4f4; padding-bottom: 200px; }
        .navbar { background: #B91C1C; color: white; }
        .btn-verbo { background: #B91C1C; color: white; border: none; }
        .btn-verbo:hover { background: #900000; color: white; }
        
        /* PAINEL DE DEBUG (Para vermos o erro) */
        #debug-panel {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 150px;
            background: black; color: #0f0; font-family: monospace;
            padding: 10px; overflow-y: scroll; z-index: 9999;
            border-top: 3px solid red; font-size: 12px;
        }
    </style>
</head>
<body>

    <nav class="navbar p-3 mb-4">
        <div class="container">
            <h4 class="m-0">IEVV Zona Leste</h4>
        </div>
    </nav>

    <div class="container">
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card p-3 text-center">
                    <h3>Membros</h3>
                    <h1 id="total-membros">...</h1>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 text-center">
                    <h3>칔ltimo Culto</h3>
                    <div id="ultimo-culto">Carregando...</div>
                </div>
            </div>
        </div>

        <hr>

        <div class="d-flex gap-2 mb-4">
            <button class="btn btn-verbo btn-lg" onclick="abrirModal('modalMembro')">Cadastrar Membro</button>
            <button class="btn btn-dark btn-lg" onclick="abrirModal('modalCulto')">Relat칩rio de Culto</button>
            <button class="btn btn-outline-dark" onclick="carregarDados()">游댃 Atualizar Dados</button>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h5>Membros Recentes</h5>
                <ul class="list-group" id="lista-membros"></ul>
            </div>
            <div class="col-md-6">
                <h5>Hist칩rico Cultos</h5>
                <ul class="list-group" id="lista-cultos"></ul>
            </div>
        </div>

    </div>

    <div class="modal" id="modalMembro" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Novo Membro</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" id="m_nome" class="form-control mb-2" placeholder="Nome Completo">
                    <input type="text" id="m_telefone" class="form-control mb-2" placeholder="Telefone">
                    <input type="date" id="m_nasc" class="form-control mb-2">
                    <div class="d-flex gap-2">
                        <input type="text" id="m_cep" class="form-control mb-2" placeholder="CEP" onblur="buscarCep(this.value)">
                        <button type="button" class="btn btn-sm btn-secondary mb-2" onclick="buscarCep(document.getElementById('m_cep').value)">Buscar</button>
                    </div>
                    <input type="text" id="m_end" class="form-control mb-2" placeholder="Endere칞o">
                    <div class="form-check"><input type="checkbox" id="m_rhema" class="form-check-input"> <label>Fez Rhema</label></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-verbo" onclick="salvarMembro()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modalCulto" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Relat칩rio Culto</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <label>Data</label><input type="date" id="c_data" class="form-control mb-2">
                    <input type="text" id="c_ministro" class="form-control mb-2" placeholder="Ministro">
                    <div class="row">
                        <div class="col"><input type="number" id="c_homens" class="form-control" placeholder="Homens"></div>
                        <div class="col"><input type="number" id="c_mulheres" class="form-control" placeholder="Mulheres"></div>
                        <div class="col"><input type="number" id="c_criancas" class="form-control" placeholder="Crian칞as"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-verbo" onclick="salvarCulto()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="debug-panel">
        <strong>STATUS DO SISTEMA:</strong><br>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- FERRAMENTA DE LOG NA TELA ---
        function log(msg, tipo = 'info') {
            const painel = document.getElementById('debug-panel');
            const cor = tipo === 'erro' ? 'red' : '#00ff00';
            const hora = new Date().toLocaleTimeString();
            painel.innerHTML += `<div style="color:${cor}">[${hora}] ${msg}</div>`;
            painel.scrollTop = painel.scrollHeight;
        }

        // --- INICIALIZA칂츾O ---
        const SB_URL = 'https://nekbbkenxcukoortusge.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5la2Jia2VueGN1a29vcnR1c2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTU5MDIsImV4cCI6MjA3ODk3MTkwMn0.D72914Vyz1du1ZDKoNDdwT7YI-D8WPgZe38LbBV2bfc';
        
        let supabase;

        try {
            log("Iniciando conex칚o com Supabase...");
            supabase = window.supabase.createClient(SB_URL, SB_KEY);
            log("Biblioteca carregada. Testando conex칚o...");
            carregarDados();
        } catch (e) {
            log("ERRO FATAL: Biblioteca Supabase n칚o carregou. Verifique sua internet.", "erro");
        }

        function abrirModal(id) {
            new bootstrap.Modal(document.getElementById(id)).show();
        }

        // --- BUSCA CEP ---
        async function buscarCep(cep) {
            cep = cep.replace(/\D/g, '');
            if(cep.length !== 8) return alert("CEP inv치lido");
            
            log(`Buscando CEP: ${cep}...`);
            try {
                const req = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const res = await req.json();
                if(res.erro) {
                    log("CEP n칚o encontrado no ViaCEP", "erro");
                    alert("CEP n칚o encontrado");
                } else {
                    document.getElementById('m_end').value = `${res.logradouro}, ${res.bairro} - ${res.localidade}`;
                    log("Endere칞o encontrado!");
                }
            } catch(e) {
                log("Erro de conex칚o com ViaCEP: " + e.message, "erro");
            }
        }

        // --- SALVAR MEMBRO ---
        async function salvarMembro() {
            const nome = document.getElementById('m_nome').value;
            if(!nome) return alert("Preencha o nome");

            log("Tentando salvar membro...");
            
            const { error } = await supabase.from('membros').insert([{
                nome: nome,
                telefone: document.getElementById('m_telefone').value,
                data_nascimento: document.getElementById('m_nasc').value || null,
                cep: document.getElementById('m_cep').value,
                endereco: document.getElementById('m_end').value,
                fez_rhema: document.getElementById('m_rhema').checked
            }]);

            if(error) {
                log("ERRO AO SALVAR MEMBRO: " + error.message + ". DETALHE: " + JSON.stringify(error), "erro");
                alert("Erro ao salvar! Veja o painel preto abaixo.");
            } else {
                log("Membro salvo com sucesso!");
                alert("Salvo!");
                carregarDados();
                bootstrap.Modal.getInstance(document.getElementById('modalMembro')).hide();
            }
        }

        // --- SALVAR CULTO ---
        async function salvarCulto() {
            const dataCulto = document.getElementById('c_data').value;
            if(!dataCulto) return alert("Selecione a data");

            log("Tentando salvar culto...");

            const { error } = await supabase.from('cultos').insert([{
                data_culto: dataCulto,
                ministro: document.getElementById('c_ministro').value,
                qtd_homens: document.getElementById('c_homens').value || 0,
                qtd_mulheres: document.getElementById('c_mulheres').value || 0,
                qtd_criancas: document.getElementById('c_criancas').value || 0
            }]);

            if(error) {
                log("ERRO AO SALVAR CULTO: " + error.message, "erro");
                alert("Erro! Veja o painel preto.");
            } else {
                log("Culto salvo!");
                alert("Salvo!");
                carregarDados();
                bootstrap.Modal.getInstance(document.getElementById('modalCulto')).hide();
            }
        }

        // --- CARREGAR DADOS ---
        async function carregarDados() {
            log("Atualizando dashboard...");
            
            // Membros
            const { count, error: errM } = await supabase.from('membros').select('*', { count: 'exact', head: true });
            if(errM) log("Erro ao ler membros: " + errM.message, "erro");
            else document.getElementById('total-membros').innerText = count;

            const { data: listaM } = await supabase.from('membros').select('nome, fez_rhema').order('nome').limit(5);
            if(listaM) {
                document.getElementById('lista-membros').innerHTML = listaM.map(m => 
                    `<li class="list-group-item d-flex justify-content-between">
                        ${m.nome} ${m.fez_rhema ? '<span class="badge bg-danger">Rhema</span>' : ''}
                    </li>`
                ).join('');
            }

            // Cultos
            const { data: cultos, error: errC } = await supabase.from('cultos').select('*').order('data_culto', {ascending: false}).limit(5);
            if(errC) {
                log("Erro ao ler cultos: " + errC.message, "erro");
                if(errC.message.includes("relation") && errC.message.includes("does not exist")) {
                    log("URGENTE: VOC칅 N츾O RODOU O C칍DIGO SQL NO SUPABASE PARA CRIAR AS TABELAS.", "erro");
                }
            } else if(cultos.length > 0) {
                document.getElementById('ultimo-culto').innerHTML = `${cultos[0].data_culto}<br><strong>${cultos[0].ministro}</strong>`;
                document.getElementById('lista-cultos').innerHTML = cultos.map(c => 
                    `<li class="list-group-item">${c.data_culto} - ${c.ministro}</li>`
                ).join('');
            } else {
                document.getElementById('ultimo-culto').innerText = "Nenhum registro";
            }
            
            log("Dados atualizados.");
        }
    </script>
</body>
</html>
