<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Verbo da Vida - Zona Leste</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --verbo-red: #c8102e; /* Tom aproximado do vermelho Verbo da Vida */
            --verbo-blue: #003366;
            --bg-light: #f8f9fa;
        }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .sidebar { min-height: 100vh; background-color: var(--verbo-blue); color: white; }
        .sidebar a { color: rgba(255,255,255,0.8); text-decoration: none; padding: 10px 15px; display: block; border-radius: 5px; margin-bottom: 5px; transition: 0.3s; }
        .sidebar a:hover, .sidebar a.active { background-color: var(--verbo-red); color: white; }
        .card-custom { border: none; shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.3s; border-radius: 10px; }
        .card-custom:hover { transform: translateY(-5px); }
        .header-title { color: var(--verbo-blue); font-weight: 700; }
        .btn-verbo { background-color: var(--verbo-red); color: white; border: none; }
        .btn-verbo:hover { background-color: #a00d25; color: white; }
        .stat-card { border-left: 5px solid var(--verbo-red); }
        
        /* Loading overlay */
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loading"><div class="spinner-border text-danger" role="status"></div></div>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 col-lg-2 sidebar p-3 d-flex flex-column">
            <h4 class="text-center mb-4"><i class="fa-solid fa-church"></i> IEVV<br><small style="font-size: 0.6em;">Zona Leste</small></h4>
            <nav>
                <a href="#" onclick="showSection('dashboard')" class="active" id="nav-dashboard"><i class="fa-solid fa-chart-line me-2"></i> Dashboard</a>
                <a href="#" onclick="showSection('cultos')" id="nav-cultos"><i class="fa-solid fa-calendar-days me-2"></i> Cultos</a>
                <a href="#" onclick="showSection('membros')" id="nav-membros"><i class="fa-solid fa-users me-2"></i> Membros</a>
            </nav>
            <div class="mt-auto text-center small text-white-50">
                &copy; 2024 Verbo da Vida
            </div>
        </div>

        <div class="col-md-9 col-lg-10 p-4">
            
            <div id="section-dashboard">
                <h2 class="header-title mb-4">Vis√£o Geral</h2>
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="card card-custom stat-card p-3">
                            <h6 class="text-muted">Total de Membros</h6>
                            <h3 id="dash-total-membros">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-custom stat-card p-3" style="border-left-color: var(--verbo-blue);">
                            <h6 class="text-muted">M√©dia de P√∫blico</h6>
                            <h3 id="dash-media-publico">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-custom stat-card p-3" style="border-left-color: #28a745;">
                            <h6 class="text-muted">Graduados Rhema</h6>
                            <h3 id="dash-rhema">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-custom stat-card p-3" style="border-left-color: #ffc107;">
                            <h6 class="text-muted">Aniversariantes (M√™s)</h6>
                            <h3 id="dash-niver">0</h3>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="card card-custom p-3">
                            <h5>Frequ√™ncia nos √öltimos Cultos</h5>
                            <canvas id="chartAttendance"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-custom p-3">
                            <h5>Distribui√ß√£o (√öltimo Culto)</h5>
                            <canvas id="chartDemographics"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-cultos" style="display: none;">
                <h2 class="header-title mb-4">Gerenciamento de Cultos</h2>
                
                <div class="card card-custom p-4 mb-4">
                    <h5>Novo Relat√≥rio de Culto</h5>
                    <form id="form-culto" onsubmit="salvarCulto(event)">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Data</label>
                                <input type="date" class="form-control" id="culto-data" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">In√≠cio</label>
                                <input type="time" class="form-control" id="culto-inicio" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">T√©rmino</label>
                                <input type="time" class="form-control" id="culto-termino" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Ministro</label>
                                <input type="text" class="form-control" id="culto-ministro" placeholder="Nome do pregador" required>
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">Dirigente</label>
                                <input type="text" class="form-control" id="culto-dirigente" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tempo Ministra√ß√£o (min)</label>
                                <input type="number" class="form-control" id="culto-tempo-min" placeholder="Ex: 50">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tempo Dirigente (min)</label>
                                <input type="number" class="form-control" id="culto-tempo-dir" placeholder="Ex: 30">
                            </div>

                            <div class="col-md-4">
                                <label class="form-label"><i class="fa-solid fa-person"></i> Homens</label>
                                <input type="number" class="form-control" id="culto-homens" value="0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fa-solid fa-person-dress"></i> Mulheres</label>
                                <input type="number" class="form-control" id="culto-mulheres" value="0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fa-solid fa-child"></i> Crian√ßas</label>
                                <input type="number" class="form-control" id="culto-criancas" value="0">
                            </div>
                            
                            <div class="col-12 text-end">
                                <button type="submit" class="btn btn-verbo"><i class="fa-solid fa-save"></i> Salvar Relat√≥rio</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="card card-custom p-3">
                    <h5>Hist√≥rico de Cultos</h5>
                    <div class="table-responsive">
                        <table class="table table-hover" id="tabela-cultos">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Ministro</th>
                                    <th>Total Pessoas</th>
                                    <th>Tempo Palavra</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="section-membros" style="display: none;">
                <h2 class="header-title mb-4">Cadastro de Membros</h2>

                <div class="card card-custom p-4 mb-4">
                    <form id="form-membro" onsubmit="salvarMembro(event)">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nome Completo</label>
                                <input type="text" class="form-control" id="membro-nome" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Data Nascimento</label>
                                <input type="date" class="form-control" id="membro-nasc">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Telefone</label>
                                <input type="text" class="form-control" id="membro-fone" placeholder="(11) 99999-9999">
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">CEP</label>
                                <input type="text" class="form-control" id="membro-cep" onblur="buscarCep(this.value)" placeholder="00000-000">
                            </div>
                            <div class="col-md-9">
                                <label class="form-label">Endere√ßo</label>
                                <input type="text" class="form-control" id="membro-endereco" readonly>
                            </div>

                            <div class="col-md-4">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="check-rhema">
                                    <label class="form-check-label">Fez Rhema?</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="check-ministros">
                                    <label class="form-check-label">Escola de Ministros?</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="check-missoes">
                                    <label class="form-check-label">Escola de Miss√µes?</label>
                                </div>
                            </div>

                            <div class="col-12 text-end">
                                <button type="submit" class="btn btn-verbo"><i class="fa-solid fa-user-plus"></i> Cadastrar Membro</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <select class="form-select" id="filtro-membros" onchange="carregarMembros()">
                            <option value="todos">Todos os Membros</option>
                            <option value="aniversariantes">üéÇ Aniversariantes do M√™s</option>
                            <option value="rhema">üéì Graduados Rhema</option>
                            <option value="ministros">üî• Escola de Ministros</option>
                        </select>
                    </div>
                </div>

                <div class="card card-custom p-3">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tabela-membros">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>Nascimento</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // CONFIGURA√á√ÉO SUPABASE
    const SUPABASE_URL = 'https://nekbbkenxcukoortusge.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5la2Jia2VueGN1a29vcnR1c2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTU5MDIsImV4cCI6MjA3ODk3MTkwMn0.D72914Vyz1du1ZDKoNDdwT7YI-D8WPgZe38LbBV2bfc';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Navega√ß√£o
    function showSection(sectionId) {
        document.querySelectorAll('[id^="section-"]').forEach(el => el.style.display = 'none');
        document.getElementById('section-' + sectionId).style.display = 'block';
        
        document.querySelectorAll('.sidebar a').forEach(el => el.classList.remove('active'));
        document.getElementById('nav-' + sectionId).classList.add('active');

        if(sectionId === 'dashboard') carregarDashboard();
        if(sectionId === 'membros') carregarMembros();
        if(sectionId === 'cultos') carregarCultos();
    }

    // --- L√ìGICA MEMBROS ---

    async function buscarCep(cep) {
        cep = cep.replace(/\D/g, '');
        if (cep.length === 8) {
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                if (!data.erro) {
                    document.getElementById('membro-endereco').value = `${data.logradouro}, ${data.bairro} - ${data.localidade}/${data.uf}`;
                } else {
                    alert('CEP n√£o encontrado.');
                }
            } catch (e) {
                console.error(e);
            }
        }
    }

    async function salvarMembro(e) {
        e.preventDefault();
        loading(true);
        
        const membro = {
            nome: document.getElementById('membro-nome').value,
            data_nascimento: document.getElementById('membro-nasc').value,
            telefone: document.getElementById('membro-fone').value,
            cep: document.getElementById('membro-cep').value,
            endereco: document.getElementById('membro-endereco').value,
            fez_rhema: document.getElementById('check-rhema').checked,
            fez_escola_ministros: document.getElementById('check-ministros').checked,
            fez_escola_missoes: document.getElementById('check-missoes').checked
        };

        const { error } = await supabase.from('membros').insert([membro]);
        
        loading(false);
        if (error) {
            alert('Erro ao salvar: ' + error.message);
        } else {
            alert('Membro cadastrado com sucesso!');
            document.getElementById('form-membro').reset();
            carregarMembros();
        }
    }

    async function carregarMembros() {
        const filtro = document.getElementById('filtro-membros').value;
        let query = supabase.from('membros').select('*').order('nome', { ascending: true });

        if (filtro === 'rhema') query = query.eq('fez_rhema', true);
        if (filtro === 'ministros') query = query.eq('fez_escola_ministros', true);

        const { data, error } = await query;
        
        if (error) return console.error(error);

        const tbody = document.querySelector('#tabela-membros tbody');
        tbody.innerHTML = '';

        // Filtro de Aniversariantes (feito no JS pois Supabase filtra data completa)
        const mesAtual = new Date().getMonth();
        const dadosFiltrados = filtro === 'aniversariantes' 
            ? data.filter(m => m.data_nascimento && new Date(m.data_nascimento).getMonth() === mesAtual)
            : data;

        dadosFiltrados.forEach(m => {
            const badges = [];
            if(m.fez_rhema) badges.push('<span class="badge bg-primary">Rhema</span>');
            if(m.fez_escola_ministros) badges.push('<span class="badge bg-danger">Ministros</span>');
            
            tbody.innerHTML += `
                <tr>
                    <td>${m.nome}</td>
                    <td>${m.telefone || '-'}</td>
                    <td>${formatarData(m.data_nascimento)}</td>
                    <td>${badges.join(' ')}</td>
                </tr>
            `;
        });
    }

    // --- L√ìGICA CULTOS ---

    async function salvarCulto(e) {
        e.preventDefault();
        loading(true);

        const culto = {
            data_culto: document.getElementById('culto-data').value,
            hora_inicio: document.getElementById('culto-inicio').value,
            hora_termino: document.getElementById('culto-termino').value,
            ministro: document.getElementById('culto-ministro').value,
            dirigente: document.getElementById('culto-dirigente').value,
            tempo_ministracao: parseInt(document.getElementById('culto-tempo-min').value) || 0,
            tempo_dirigente: parseInt(document.getElementById('culto-tempo-dir').value) || 0,
            qtd_homens: parseInt(document.getElementById('culto-homens').value) || 0,
            qtd_mulheres: parseInt(document.getElementById('culto-mulheres').value) || 0,
            qtd_criancas: parseInt(document.getElementById('culto-criancas').value) || 0,
        };

        const { error } = await supabase.from('cultos').insert([culto]);
        
        loading(false);
        if (error) {
            alert('Erro ao salvar culto: ' + error.message);
        } else {
            alert('Relat√≥rio de culto salvo!');
            document.getElementById('form-culto').reset();
            carregarCultos();
        }
    }

    async function carregarCultos() {
        const { data, error } = await supabase.from('cultos').select('*').order('data_culto', { ascending: false });
        if(error) return;

        const tbody = document.querySelector('#tabela-cultos tbody');
        tbody.innerHTML = '';
        
        data.forEach(c => {
            const total = (c.qtd_homens || 0) + (c.qtd_mulheres || 0) + (c.qtd_criancas || 0);
            tbody.innerHTML += `
                <tr>
                    <td>${formatarData(c.data_culto)}</td>
                    <td>${c.ministro}</td>
                    <td><span class="badge bg-secondary">${total} pessoas</span></td>
                    <td>${c.tempo_ministracao} min</td>
                </tr>
            `;
        });
    }

    // --- DASHBOARD ---

    async function carregarDashboard() {
        // Buscar totais
        const { count: totalMembros } = await supabase.from('membros').select('*', { count: 'exact', head: true });
        const { count: totalRhema } = await supabase.from('membros').select('*', { count: 'exact', head: true }).eq('fez_rhema', true);
        
        // Calcular Aniversariantes via JS (limita√ß√£o de filtro de data simples)
        const { data: todosMembros } = await supabase.from('membros').select('data_nascimento');
        const niverMes = todosMembros ? todosMembros.filter(m => m.data_nascimento && new Date(m.data_nascimento).getMonth() === new Date().getMonth()).length : 0;

        // Dados de Cultos para gr√°ficos
        const { data: cultos } = await supabase.from('cultos').select('*').order('data_culto', { ascending: true }).limit(5);
        
        // Atualizar Cards
        document.getElementById('dash-total-membros').innerText = totalMembros || 0;
        document.getElementById('dash-rhema').innerText = totalRhema || 0;
        document.getElementById('dash-niver').innerText = niverMes;

        if (cultos && cultos.length > 0) {
            const ultimo = cultos[cultos.length - 1];
            const totais = cultos.map(c => (c.qtd_homens + c.qtd_mulheres + c.qtd_criancas));
            const media = Math.round(totais.reduce((a, b) => a + b, 0) / totais.length);
            
            document.getElementById('dash-media-publico').innerText = media;

            // Gr√°fico Linha (Frequ√™ncia)
            renderChart('chartAttendance', 'line', cultos.map(c => formatarData(c.data_culto)), totais, 'Total de Pessoas');
            
            // Gr√°fico Pizza (Demogr√°fico √öltimo Culto)
            renderPieChart('chartDemographics', [ultimo.qtd_homens, ultimo.qtd_mulheres, ultimo.qtd_criancas]);
        }
    }

    // --- UTILIT√ÅRIOS ---
    
    function formatarData(dataISO) {
        if(!dataISO) return '-';
        const [ano, mes, dia] = dataISO.split('-');
        return `${dia}/${mes}/${ano}`;
    }

    function loading(show) {
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }

    // Gr√°ficos Helper
    let chartInstance1 = null;
    let chartInstance2 = null;

    function renderChart(canvasId, type, labels, dataPoints, label) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if(chartInstance1) chartInstance1.destroy();
        chartInstance1 = new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: dataPoints,
                    borderColor: '#c8102e',
                    backgroundColor: 'rgba(200, 16, 46, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            }
        });
    }

    function renderPieChart(canvasId, dataPoints) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if(chartInstance2) chartInstance2.destroy();
        chartInstance2 = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Homens', 'Mulheres', 'Crian√ßas'],
                datasets: [{
                    data: dataPoints,
                    backgroundColor: ['#003366', '#c8102e', '#ffc107']
                }]
            }
        });
    }

    // Iniciar na Dashboard
    showSection('dashboard');

</script>
</body>
</html>
