<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Verbo da Vida | Zona Leste</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #ba0c2f; /* Vermelho Verbo */
            --secondary-color: #0f172a; /* Azul Escuro Profundo */
            --bg-body: #f1f5f9;
            --text-dark: #334155;
            --white: #ffffff;
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Montserrat', sans-serif;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        /* Sidebar Styling */
        .sidebar {
            width: 260px;
            height: 100vh;
            background: var(--secondary-color);
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 20px;
            z-index: 1000;
            transition: all 0.3s;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-brand {
            color: var(--white);
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            padding-bottom: 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .sidebar-menu a {
            padding: 15px 25px;
            text-decoration: none;
            font-size: 0.95rem;
            color: #94a3b8;
            display: block;
            transition: 0.3s;
            border-left: 4px solid transparent;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            color: var(--white);
            background: rgba(255,255,255,0.05);
            border-left-color: var(--primary-color);
        }

        .sidebar-menu i { margin-right: 10px; width: 20px; text-align: center; }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            padding: 30px;
        }

        /* Cards */
        .card-dashboard {
            background: var(--white);
            border: none;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
            height: 100%;
        }

        .card-dashboard:hover { transform: translateY(-3px); }

        .stat-value { font-size: 2rem; font-weight: 700; color: var(--secondary-color); margin-bottom: 0; }
        .stat-label { color: #64748b; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .stat-icon { font-size: 2.5rem; opacity: 0.1; position: absolute; right: 20px; top: 20px; }

        /* Buttons */
        .btn-verbo {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            transition: 0.3s;
        }
        .btn-verbo:hover { background-color: #900a25; color: white; box-shadow: 0 4px 12px rgba(186, 12, 47, 0.3); }

        /* Status Connection */
        #connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            background: white;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .status-ok { background-color: #10b981; }
        .status-err { background-color: #ef4444; }

        /* Responsive */
        @media(max-width: 768px) {
            .sidebar { width: 70px; padding-top: 80px; }
            .sidebar-brand { display: none; }
            .sidebar-menu span { display: none; }
            .main-content { margin-left: 70px; padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="connection-status">
        <span class="status-dot status-err" id="status-dot"></span>
        <span id="status-text">Verificando conexÃ£o...</span>
    </div>

    <div class="sidebar">
        <div class="sidebar-brand">
            IEVV ZONA LESTE
        </div>
        <div class="sidebar-menu">
            <a href="#" onclick="nav('dashboard')" id="link-dashboard" class="active">
                <i class="fa-solid fa-chart-pie"></i> <span>Dashboard</span>
            </a>
            <a href="#" onclick="nav('cultos')" id="link-cultos">
                <i class="fa-solid fa-church"></i> <span>Cultos</span>
            </a>
            <a href="#" onclick="nav('membros')" id="link-membros">
                <i class="fa-solid fa-users"></i> <span>Membros</span>
            </a>
        </div>
    </div>

    <div class="main-content">
        
        <section id="view-dashboard">
            <h2 class="mb-4 fw-bold">VisÃ£o Geral</h2>
            
            <div class="row g-4 mb-5">
                <div class="col-md-3">
                    <div class="card-dashboard position-relative">
                        <i class="fa-solid fa-users stat-icon text-primary"></i>
                        <p class="stat-label">Total Membros</p>
                        <h3 class="stat-value" id="dash-total">0</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-dashboard position-relative">
                        <i class="fa-solid fa-cake-candles stat-icon text-warning"></i>
                        <p class="stat-label">Aniversariantes (MÃªs)</p>
                        <h3 class="stat-value" id="dash-niver">0</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-dashboard position-relative">
                        <i class="fa-solid fa-graduation-cap stat-icon text-success"></i>
                        <p class="stat-label">Rhema</p>
                        <h3 class="stat-value" id="dash-rhema">0</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-dashboard position-relative">
                        <i class="fa-solid fa-fire stat-icon text-danger"></i>
                        <p class="stat-label">MÃ©dia PÃºblico</p>
                        <h3 class="stat-value" id="dash-media">0</h3>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-8">
                    <div class="card-dashboard">
                        <h5 class="mb-4 fw-bold">FrequÃªncia dos Ãšltimos Cultos</h5>
                        <canvas id="chartLine"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card-dashboard">
                        <h5 class="mb-4 fw-bold">PÃºblico (Ãšltimo Culto)</h5>
                        <canvas id="chartPie"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-cultos" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">Gerenciamento de Culto</h2>
            </div>

            <div class="card-dashboard mb-4">
                <h5 class="mb-3 text-secondary">Novo RelatÃ³rio</h5>
                <form id="form-culto" onsubmit="salvarCulto(event)">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Data</label>
                            <input type="date" id="c-data" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">InÃ­cio</label>
                            <input type="time" id="c-inicio" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">TÃ©rmino</label>
                            <input type="time" id="c-termino" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Ministro</label>
                            <input type="text" id="c-ministro" class="form-control" placeholder="Pregador" required>
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Dirigente</label>
                            <input type="text" id="c-dirigente" class="form-control" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Tempo Palavra (min)</label>
                            <input type="number" id="c-t-palavra" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Tempo Dirigente (min)</label>
                            <input type="number" id="c-t-dirigente" class="form-control">
                        </div>
                        <div class="col-md-4"></div>

                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fa-solid fa-person"></i></span>
                                <input type="number" id="c-homens" class="form-control" placeholder="Homens" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fa-solid fa-person-dress"></i></span>
                                <input type="number" id="c-mulheres" class="form-control" placeholder="Mulheres" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fa-solid fa-child"></i></span>
                                <input type="number" id="c-criancas" class="form-control" placeholder="CrianÃ§as" value="0">
                            </div>
                        </div>

                        <div class="col-12 text-end mt-4">
                            <button type="submit" class="btn-verbo">
                                <i class="fa-solid fa-check me-2"></i> Salvar Culto
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="card-dashboard">
                <h5 class="mb-3 text-secondary">HistÃ³rico Recente</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Data</th>
                                <th>Ministro</th>
                                <th>Total Pessoas</th>
                                <th>Tempo Palavra</th>
                            </tr>
                        </thead>
                        <tbody id="lista-cultos"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="view-membros" style="display: none;">
            <h2 class="mb-4 fw-bold">Cadastro de Membros</h2>

            <div class="card-dashboard mb-4">
                <form id="form-membro" onsubmit="salvarMembro(event)">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Nome Completo</label>
                            <input type="text" id="m-nome" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Nascimento</label>
                            <input type="date" id="m-nasc" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Telefone</label>
                            <input type="text" id="m-fone" class="form-control" placeholder="(00) 00000-0000">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label small text-muted">CEP (Busca AutomÃ¡tica)</label>
                            <input type="text" id="m-cep" class="form-control" onblur="buscarCep(this.value)" placeholder="00000-000">
                        </div>
                        <div class="col-md-9">
                            <label class="form-label small text-muted">EndereÃ§o</label>
                            <input type="text" id="m-endereco" class="form-control" readonly style="background-color: #f8f9fa;">
                        </div>

                        <div class="col-12 mt-4 d-flex gap-4 flex-wrap">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="m-rhema">
                                <label class="form-check-label">Graduado Rhema</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="m-ministros">
                                <label class="form-check-label">Escola de Ministros</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="m-missoes">
                                <label class="form-check-label">Escola de MissÃµes</label>
                            </div>
                        </div>

                        <div class="col-12 text-end">
                            <button type="submit" class="btn-verbo">
                                <i class="fa-solid fa-user-plus me-2"></i> Cadastrar
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <select id="filtro-membros" class="form-select" onchange="carregarMembros()">
                        <option value="todos">Todos os Membros</option>
                        <option value="aniversariantes">ðŸŽ‚ Aniversariantes do MÃªs</option>
                        <option value="rhema">ðŸŽ“ Graduados Rhema</option>
                    </select>
                </div>
            </div>

            <div class="card-dashboard">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Nome</th>
                                <th>Contato</th>
                                <th>Nascimento</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="lista-membros"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </div>

<script>
    // --- 1. CONFIGURAÃ‡ÃƒO E TESTE DE CONEXÃƒO ---
    const SUPABASE_URL = 'https://nekbbkenxcukoortusge.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5la2Jia2VueGN1a29vcnR1c2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTU5MDIsImV4cCI6MjA3ODk3MTkwMn0.D72914Vyz1du1ZDKoNDdwT7YI-D8WPgZe38LbBV2bfc';
    
    let supabase;

    try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log("Cliente Supabase iniciado");
    } catch (err) {
        alert("Erro crÃ­tico: A biblioteca do Supabase nÃ£o carregou. Verifique sua internet.");
        console.error(err);
    }

    // FunÃ§Ã£o que roda ao abrir a pÃ¡gina
    window.addEventListener('load', async () => {
        const dot = document.getElementById('status-dot');
        const text = document.getElementById('status-text');

        try {
            // Tenta um ping simples no banco
            const { data, error } = await supabase.from('membros').select('count', { count: 'exact', head: true });
            
            if (error) throw error;

            dot.classList.remove('status-err');
            dot.classList.add('status-ok');
            text.innerText = "Sistema Online e Conectado";
            
            // Se conectou, carrega os dados
            carregarDashboard();
        } catch (e) {
            console.error("Erro de conexÃ£o:", e);
            dot.classList.add('status-err');
            text.innerText = "Erro de conexÃ£o: " + e.message;
            alert("NÃ£o foi possÃ­vel conectar ao banco de dados. Verifique se vocÃª rodou o Script SQL para desativar o RLS.");
        }
    });

    // --- 2. NAVEGAÃ‡ÃƒO ---
    function nav(tela) {
        document.querySelectorAll('section').forEach(s => s.style.display = 'none');
        document.getElementById('view-' + tela).style.display = 'block';
        
        document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
        document.getElementById('link-' + tela).classList.add('active');

        if(tela === 'dashboard') carregarDashboard();
        if(tela === 'cultos') carregarCultos();
        if(tela === 'membros') carregarMembros();
    }

    // --- 3. LÃ“GICA CULTOS ---
    async function salvarCulto(e) {
        e.preventDefault();
        
        const payload = {
            data_culto: document.getElementById('c-data').value,
            hora_inicio: document.getElementById('c-inicio').value,
            hora_termino: document.getElementById('c-termino').value,
            ministro: document.getElementById('c-ministro').value,
            dirigente: document.getElementById('c-dirigente').value,
            tempo_ministracao: document.getElementById('c-t-palavra').value || 0,
            tempo_dirigente: document.getElementById('c-t-dirigente').value || 0,
            qtd_homens: parseInt(document.getElementById('c-homens').value) || 0,
            qtd_mulheres: parseInt(document.getElementById('c-mulheres').value) || 0,
            qtd_criancas: parseInt(document.getElementById('c-criancas').value) || 0
        };

        const { error } = await supabase.from('cultos').insert([payload]);

        if (error) {
            alert("Erro ao salvar: " + error.message);
        } else {
            alert("Culto registrado com sucesso!");
            e.target.reset();
            carregarCultos();
        }
    }

    async function carregarCultos() {
        const { data, error } = await supabase.from('cultos').select('*').order('data_culto', { ascending: false });
        if(error) return console.error(error);

        const lista = document.getElementById('lista-cultos');
        lista.innerHTML = '';

        data.forEach(c => {
            const total = c.qtd_homens + c.qtd_mulheres + c.qtd_criancas;
            lista.innerHTML += `
                <tr>
                    <td class="fw-bold">${formatDate(c.data_culto)}</td>
                    <td>${c.ministro}</td>
                    <td><span class="badge bg-light text-dark border">${total}</span></td>
                    <td>${c.tempo_ministracao} min</td>
                </tr>
            `;
        });
    }

    // --- 4. LÃ“GICA MEMBROS ---
    async function buscarCep(cep) {
        cep = cep.replace(/\D/g, '');
        if (cep.length === 8) {
            const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await res.json();
            if(!data.erro) {
                document.getElementById('m-endereco').value = `${data.logradouro}, ${data.bairro} - ${data.localidade}/${data.uf}`;
            }
        }
    }

    async function salvarMembro(e) {
        e.preventDefault();
        
        const payload = {
            nome: document.getElementById('m-nome').value,
            data_nascimento: document.getElementById('m-nasc').value,
            telefone: document.getElementById('m-fone').value,
            cep: document.getElementById('m-cep').value,
            endereco: document.getElementById('m-endereco').value,
            fez_rhema: document.getElementById('m-rhema').checked,
            fez_escola_ministros: document.getElementById('m-ministros').checked,
            fez_escola_missoes: document.getElementById('m-missoes').checked
        };

        const { error } = await supabase.from('membros').insert([payload]);

        if (error) {
            alert("Erro ao cadastrar membro: " + error.message);
        } else {
            alert("Membro cadastrado!");
            e.target.reset();
            carregarMembros();
        }
    }

    async function carregarMembros() {
        const filtro = document.getElementById('filtro-membros').value;
        let query = supabase.from('membros').select('*').order('nome', {ascending: true});
        
        if(filtro === 'rhema') query = query.eq('fez_rhema', true);

        const { data, error } = await query;
        if(error) return;

        const lista = document.getElementById('lista-membros');
        lista.innerHTML = '';

        const mesAtual = new Date().getMonth();
        
        const dadosFinais = filtro === 'aniversariantes' 
            ? data.filter(m => m.data_nascimento && new Date(m.data_nascimento).getMonth() === mesAtual)
            : data;

        dadosFinais.forEach(m => {
            let tags = '';
            if(m.fez_rhema) tags += '<span class="badge bg-primary me-1">Rhema</span>';
            if(m.fez_escola_ministros) tags += '<span class="badge bg-danger">Ministro</span>';

            lista.innerHTML += `
                <tr>
                    <td class="fw-bold">${m.nome}</td>
                    <td>${m.telefone || '-'}</td>
                    <td>${formatDate(m.data_nascimento)}</td>
                    <td>${tags}</td>
                </tr>
            `;
        });
    }

    // --- 5. DASHBOARD & GRÃFICOS ---
    let chartL, chartP;

    async function carregarDashboard() {
        // Totais
        const { count: totalM } = await supabase.from('membros').select('*', { count: 'exact', head: true });
        const { count: totalR } = await supabase.from('membros').select('*', { count: 'exact', head: true }).eq('fez_rhema', true);
        
        // Aniversariantes
        const { data: allM } = await supabase.from('membros').select('data_nascimento');
        const niver = allM ? allM.filter(m => m.data_nascimento && new Date(m.data_nascimento).getMonth() === new Date().getMonth()).length : 0;

        document.getElementById('dash-total').innerText = totalM || 0;
        document.getElementById('dash-rhema').innerText = totalR || 0;
        document.getElementById('dash-niver').innerText = niver;

        // GrÃ¡ficos
        const { data: cultos } = await supabase.from('cultos').select('*').order('data_culto', { ascending: true }).limit(5);
        
        if(cultos && cultos.length > 0) {
            // MÃ©dia
            const totais = cultos.map(c => c.qtd_homens + c.qtd_mulheres + c.qtd_criancas);
            const media = Math.round(totais.reduce((a,b)=>a+b,0) / totais.length);
            document.getElementById('dash-media').innerText = media;

            // Render GrÃ¡fico Linha
            const ctxL = document.getElementById('chartLine');
            if(chartL) chartL.destroy();
            chartL = new Chart(ctxL, {
                type: 'line',
                data: {
                    labels: cultos.map(c => formatDate(c.data_culto).substring(0,5)),
                    datasets: [{
                        label: 'PresenÃ§a Total',
                        data: totais,
                        borderColor: '#ba0c2f',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(186, 12, 47, 0.1)'
                    }]
                }
            });

            // Render Pizza (Ãšltimo culto)
            const ultimo = cultos[cultos.length-1];
            const ctxP = document.getElementById('chartPie');
            if(chartP) chartP.destroy();
            chartP = new Chart(ctxP, {
                type: 'doughnut',
                data: {
                    labels: ['Homens', 'Mulheres', 'CrianÃ§as'],
                    datasets: [{
                        data: [ultimo.qtd_homens, ultimo.qtd_mulheres, ultimo.qtd_criancas],
                        backgroundColor: ['#0f172a', '#ba0c2f', '#fbbf24']
                    }]
                }
            });
        }
    }

    function formatDate(dateString) {
        if(!dateString) return '-';
        const [y, m, d] = dateString.split('-');
        return `${d}/${m}/${y}`;
    }

</script>
</body>
</html>
