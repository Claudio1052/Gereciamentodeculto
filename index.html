<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IEVV Zona Leste - Gestão de Culto</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.40.0/dist/umd/supabase.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --verbo-blue: #002855; --verbo-red: #C8102E; --light: #f8f9fa; }
        body { background: #eef2f7; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Layout */
        .sidebar { width: 250px; height: 100vh; background: var(--verbo-blue); position: fixed; color: white; padding: 20px; transition: 0.3s; }
        .main-content { margin-left: 250px; padding: 30px; transition: 0.3s; }
        
        /* Navigation */
        .nav-link { color: #adb5bd; padding: 12px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; display: block; text-decoration: none; }
        .nav-link:hover, .nav-link.active { background: var(--verbo-red); color: white; }
        
        /* Cards */
        .card-stat { background: white; border-radius: 12px; padding: 20px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .card-stat h3 { font-size: 2rem; font-weight: bold; margin: 5px 0; color: var(--verbo-blue); }
        
        /* Botões */
        .btn-verbo { background: var(--verbo-red); color: white; border-radius: 8px; padding: 10px 20px; border: none; font-weight: 600; }
        .btn-verbo:hover { background: #a00d25; color: white; }

        /* Status de Conexão */
        #status-bar { position: fixed; bottom: 20px; right: 20px; padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 9999; }
        .online { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .offline { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        @media (max-width: 768px) {
            .sidebar { width: 70px; padding: 10px; }
            .sidebar span { display: none; }
            .main-content { margin-left: 70px; }
        }
    </style>
</head>
<body>

    <div id="status-bar" class="offline">Conectando ao Supabase...</div>

    <div class="sidebar">
        <h5 class="text-center mb-4"><span>VERBO DA VIDA</span></h5>
        <a class="nav-link active" onclick="showTab('dash')"><i class="fas fa-chart-line me-2"></i> <span>Dashboard</span></a>
        <a class="nav-link" onclick="showTab('cultos')"><i class="fas fa-bible me-2"></i> <span>Cultos</span></a>
        <a class="nav-link" onclick="showTab('membros')"><i class="fas fa-users me-2"></i> <span>Membros</span></a>
    </div>

    <div class="main-content">
        
        <div id="tab-dash" class="tab-content">
            <h2 class="mb-4">Dashboard</h2>
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card-stat text-center">
                        <p class="text-muted mb-0">Total Membros</p>
                        <h3 id="stat-membros">0</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-stat text-center">
                        <p class="text-muted mb-0">Aniversariantes</p>
                        <h3 id="stat-niver">0</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-stat text-center">
                        <p class="text-muted mb-0">Média Público</p>
                        <h3 id="stat-media">0</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-stat text-center">
                        <p class="text-muted mb-0">Graduados Rhema</p>
                        <h3 id="stat-rhema">0</h3>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-8"><div class="card-stat"><h5>Presença nos Cultos</h5><canvas id="chartLine"></canvas></div></div>
                <div class="col-md-4"><div class="card-stat"><h5>Último Culto</h5><canvas id="chartPie"></canvas></div></div>
            </div>
        </div>

        <div id="tab-cultos" class="tab-content" style="display:none">
            <h2 class="mb-4">Registro de Culto</h2>
            <div class="card-stat mb-4">
                <form id="form-culto">
                    <div class="row g-3">
                        <div class="col-md-3"><label>Data</label><input type="date" class="form-control" id="c-data" required></div>
                        <div class="col-md-3"><label>Início</label><input type="time" class="form-control" id="c-inicio"></div>
                        <div class="col-md-3"><label>Término</label><input type="time" class="form-control" id="c-termino"></div>
                        <div class="col-md-3"><label>Ministro</label><input type="text" class="form-control" id="c-ministro" required></div>
                        <div class="col-md-3"><label>Dirigente</label><input type="text" class="form-control" id="c-dirigente"></div>
                        <div class="col-md-3"><label>Min. Palavra</label><input type="number" class="form-control" id="c-t-palavra"></div>
                        <div class="col-md-2"><label>Homens</label><input type="number" class="form-control" id="c-h" value="0"></div>
                        <div class="col-md-2"><label>Mulheres</label><input type="number" class="form-control" id="c-m" value="0"></div>
                        <div class="col-md-2"><label>Crianças</label><input type="number" class="form-control" id="c-c" value="0"></div>
                        <div class="col-12 text-end"><button type="submit" class="btn-verbo">Salvar Culto</button></div>
                    </div>
                </form>
            </div>
            <div class="card-stat"><table class="table"><thead><tr><th>Data</th><th>Ministro</th><th>Total</th></tr></thead><tbody id="lista-cultos"></tbody></table></div>
        </div>

        <div id="tab-membros" class="tab-content" style="display:none">
            <h2 class="mb-4">Cadastro de Membros</h2>
            <div class="card-stat mb-4">
                <form id="form-membro">
                    <div class="row g-3">
                        <div class="col-md-6"><label>Nome</label><input type="text" class="form-control" id="m-nome" required></div>
                        <div class="col-md-3"><label>Nascimento</label><input type="date" class="form-control" id="m-nasc"></div>
                        <div class="col-md-3"><label>Telefone</label><input type="text" class="form-control" id="m-fone"></div>
                        <div class="col-md-3"><label>CEP</label><input type="text" class="form-control" id="m-cep" onblur="buscarCEP(this.value)"></div>
                        <div class="col-md-9"><label>Endereço</label><input type="text" class="form-control" id="m-end" readonly></div>
                        <div class="col-md-4"><input type="checkbox" id="m-rhema"> <label>Graduado Rhema</label></div>
                        <div class="col-12 text-end"><button type="submit" class="btn-verbo">Cadastrar Membro</button></div>
                    </div>
                </form>
            </div>
            <div class="card-stat"><table class="table"><thead><tr><th>Nome</th><th>Status</th><th>Nascimento</th></tr></thead><tbody id="lista-membros"></tbody></table></div>
        </div>

    </div>

    <script>
        // Configurações
        const URL = 'https://nekbbkenxcukoortusge.supabase.co';
        const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5la2Jia2VueGN1a29vcnR1c2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTU5MDIsImV4cCI6MjA3ODk3MTkwMn0.D72914Vyz1du1ZDKoNDdwT7YI-D8WPgZe38LbBV2bfc';
        
        let client;

        // Inicializar Conexão
        async function conectar() {
            try {
                // Forçar inicialização pelo UMD
                client = window.supabase.createClient(URL, KEY);
                
                // Testar conexão buscando membros
                const { data, error } = await client.from('membros').select('id').limit(1);
                
                if (error) throw error;

                document.getElementById('status-bar').className = 'online';
                document.getElementById('status-bar').innerText = 'Sistema Conectado';
                carregarDashboard();
                carregarMembros();
                carregarCultos();
            } catch (err) {
                console.error(err);
                document.getElementById('status-bar').className = 'offline';
                document.getElementById('status-bar').innerText = 'Erro: Verifique o SQL no Supabase';
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById('tab-' + tab).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // Membros
        async function carregarMembros() {
            const { data } = await client.from('membros').select('*').order('nome');
            const lista = document.getElementById('lista-membros');
            lista.innerHTML = '';
            data.forEach(m => {
                lista.innerHTML += `<tr><td>${m.nome}</td><td>${m.fez_rhema?'Rhema':''}</td><td>${m.data_nascimento || '-'}</td></tr>`;
            });
            document.getElementById('stat-membros').innerText = data.length;
        }

        document.getElementById('form-membro').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                nome: document.getElementById('m-nome').value,
                data_nascimento: document.getElementById('m-nasc').value || null,
                telefone: document.getElementById('m-fone').value,
                cep: document.getElementById('m-cep').value,
                endereco: document.getElementById('m-end').value,
                fez_rhema: document.getElementById('m-rhema').checked
            };
            const { error } = await client.from('membros').insert([payload]);
            if(!error) { alert('Membro Salvo!'); carregarMembros(); carregarDashboard(); }
        };

        // Cultos
        async function carregarCultos() {
            const { data } = await client.from('cultos').select('*').order('data_culto', {ascending: false});
            const lista = document.getElementById('lista-cultos');
            lista.innerHTML = '';
            data.forEach(c => {
                lista.innerHTML += `<tr><td>${c.data_culto}</td><td>${c.ministro}</td><td>${c.qtd_homens+c.qtd_mulheres+c.qtd_criancas}</td></tr>`;
            });
        }

        document.getElementById('form-culto').onsubmit = async (e) => {
            e.preventDefault();
            const payload = {
                data_culto: document.getElementById('c-data').value,
                hora_inicio: document.getElementById('c-inicio').value,
                hora_termino: document.getElementById('c-termino').value,
                ministro: document.getElementById('c-ministro').value,
                dirigente: document.getElementById('c-dirigente').value,
                tempo_ministracao: document.getElementById('c-t-palavra').value || 0,
                qtd_homens: parseInt(document.getElementById('c-h').value),
                qtd_mulheres: parseInt(document.getElementById('c-m').value),
                qtd_criancas: parseInt(document.getElementById('c-c').value)
            };
            const { error } = await client.from('cultos').insert([payload]);
            if(!error) { alert('Culto Salvo!'); carregarCultos(); carregarDashboard(); }
        };

        async function buscarCEP(cep) {
            const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await res.json();
            if(!data.erro) document.getElementById('m-end').value = `${data.logradouro}, ${data.bairro} - ${data.localidade}/${data.uf}`;
        }

        async function carregarDashboard() {
            const { data: cultos } = await client.from('cultos').select('*').order('data_culto', {ascending: true});
            const { data: rhema } = await client.from('membros').select('id').eq('fez_rhema', true);
            
            document.getElementById('stat-rhema').innerText = rhema?.length || 0;

            if (cultos && cultos.length > 0) {
                const ultimos = cultos.slice(-5);
                const totais = ultimos.map(c => c.qtd_homens + c.qtd_mulheres + c.qtd_criancas);
                
                // Gráfico Linha
                new Chart(document.getElementById('chartLine'), {
                    type: 'line',
                    data: { labels: ultimos.map(c => c.data_culto), datasets: [{ label: 'Público', data: totais, borderColor: '#C8102E' }] }
                });

                // Gráfico Pizza (último)
                const u = cultos[cultos.length-1];
                new Chart(document.getElementById('chartPie'), {
                    type: 'doughnut',
                    data: { labels: ['H', 'M', 'C'], datasets: [{ data: [u.qtd_homens, u.qtd_mulheres, u.qtd_criancas], backgroundColor: ['#002855', '#C8102E', '#FFC107'] }] }
                });
            }
        }

        // Rodar ao iniciar
        window.onload = conectar;
    </script>
</body>
</html>
