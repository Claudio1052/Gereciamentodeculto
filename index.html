<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Verbo da Vida - Zona Leste</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .active-tab { background-color: #2563eb; color: white; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-white shadow-lg hidden md:flex flex-col z-10">
        <div class="h-20 flex items-center justify-center border-b border-gray-200">
            <div class="text-center">
                <h1 class="text-xl font-bold text-blue-700">VERBO DA VIDA</h1>
                <p class="text-xs text-gray-500">ZONA LESTE</p>
            </div>
        </div>
        <nav class="flex-1 py-6">
            <button onclick="showSection('dashboard')" id="btn-dashboard" class="w-full text-left px-6 py-3 hover:bg-gray-100 text-gray-700 font-medium transition active-tab">
                <i class="fas fa-chart-pie mr-3"></i> Dashboard
            </button>
            <button onclick="showSection('cultos')" id="btn-cultos" class="w-full text-left px-6 py-3 hover:bg-gray-100 text-gray-700 font-medium transition">
                <i class="fas fa-church mr-3"></i> Gerenciar Cultos
            </button>
            <button onclick="showSection('membros')" id="btn-membros" class="w-full text-left px-6 py-3 hover:bg-gray-100 text-gray-700 font-medium transition">
                <i class="fas fa-users mr-3"></i> Membros
            </button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-y-auto relative">
        <header class="md:hidden bg-white h-16 shadow flex items-center justify-between px-4">
            <span class="font-bold text-blue-700">Verbo da Vida ZL</span>
            <button class="text-gray-600"><i class="fas fa-bars"></i></button>
        </header>

        <div class="p-8">
            
            <section id="dashboard" class="fade-in block">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Visão Geral</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-500">
                        <p class="text-gray-500 text-sm">Total de Membros</p>
                        <p class="text-3xl font-bold text-gray-800" id="dash-total-membros">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-500">
                        <p class="text-gray-500 text-sm">Média de Público</p>
                        <p class="text-3xl font-bold text-gray-800" id="dash-media-publico">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-yellow-500">
                        <p class="text-gray-500 text-sm">Aniversariantes do Mês</p>
                        <p class="text-3xl font-bold text-gray-800" id="dash-aniversariantes">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-purple-500">
                        <p class="text-gray-500 text-sm">Graduados Rhema</p>
                        <p class="text-3xl font-bold text-gray-800" id="dash-rhema">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="font-bold text-gray-700 mb-4">Frequência nos Últimos Cultos</h3>
                        <canvas id="chartFrequencia"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="font-bold text-gray-700 mb-4">Demografia (Homens x Mulheres x Crianças)</h3>
                        <canvas id="chartDemografia"></canvas>
                    </div>
                </div>
            </section>

            <section id="cultos" class="hidden fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Gerenciamento de Cultos</h2>
                
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-lg font-semibold mb-4 text-blue-600">Novo Relatório de Culto</h3>
                    <form id="form-culto" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="date" id="c-data" required class="p-2 border rounded" title="Data do Culto">
                        <input type="time" id="c-inicio" required class="p-2 border rounded" title="Início">
                        <input type="time" id="c-fim" required class="p-2 border rounded" title="Término">
                        
                        <input type="text" id="c-ministro" placeholder="Ministro da Noite" class="p-2 border rounded">
                        <input type="text" id="c-dirigente" placeholder="Dirigente" class="p-2 border rounded">
                        <input type="number" id="c-tempo-min" placeholder="Tempo Ministração (min)" class="p-2 border rounded">
                        <input type="number" id="c-tempo-dir" placeholder="Tempo Dirigente (min)" class="p-2 border rounded">

                        <div class="col-span-1 md:col-span-4 grid grid-cols-3 gap-4 border-t pt-4 mt-2">
                            <div>
                                <label class="text-xs text-gray-500">Homens</label>
                                <input type="number" id="c-homens" value="0" class="w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Mulheres</label>
                                <input type="number" id="c-mulheres" value="0" class="w-full p-2 border rounded">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Crianças</label>
                                <input type="number" id="c-criancas" value="0" class="w-full p-2 border rounded">
                            </div>
                        </div>

                        <button type="submit" class="col-span-1 md:col-span-4 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Salvar Relatório</button>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-6 py-3">Data</th>
                                <th class="px-6 py-3">Ministro</th>
                                <th class="px-6 py-3">Total Público</th>
                                <th class="px-6 py-3">Tempo Ministração</th>
                            </tr>
                        </thead>
                        <tbody id="lista-cultos">
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="membros" class="hidden fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Cadastro de Membros</h2>

                <div class="flex gap-4 mb-6">
                    <button onclick="filtrarAniversariantes()" class="bg-purple-100 text-purple-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-purple-200">
                        <i class="fas fa-birthday-cake mr-2"></i> Aniversariantes do Mês
                    </button>
                    <button onclick="carregarMembros()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm font-semibold hover:bg-gray-300">
                        Limpar Filtros
                    </button>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-lg font-semibold mb-4 text-blue-600">Novo Membro</h3>
                    <form id="form-membro" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="m-nome" placeholder="Nome Completo" required class="p-2 border rounded md:col-span-2">
                        <input type="date" id="m-nascimento" required class="p-2 border rounded" title="Data de Nascimento">
                        <input type="text" id="m-telefone" placeholder="Telefone (WhatsApp)" class="p-2 border rounded">
                        
                        <div class="relative">
                            <input type="text" id="m-cep" placeholder="CEP" onblur="buscarCEP(this.value)" class="w-full p-2 border rounded">
                            <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                        </div>
                        <input type="text" id="m-endereco" placeholder="Endereço" class="p-2 border rounded">
                        <input type="text" id="m-numero" placeholder="Número" class="p-2 border rounded">
                        <input type="text" id="m-bairro" placeholder="Bairro" class="p-2 border rounded">
                        <input type="text" id="m-cidade" placeholder="Cidade" class="p-2 border rounded bg-gray-50">
                        <input type="text" id="m-uf" placeholder="UF" class="p-2 border rounded bg-gray-50 w-20">

                        <div class="col-span-1 md:col-span-3 flex gap-6 mt-2 bg-gray-50 p-3 rounded">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="m-rhema" class="form-checkbox h-5 w-5 text-blue-600">
                                <span>Fez Rhema?</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="m-ministros" class="form-checkbox h-5 w-5 text-blue-600">
                                <span>Escola de Ministros?</span>
                            </label>
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="m-missoes" class="form-checkbox h-5 w-5 text-blue-600">
                                <span>Escola de Missões?</span>
                            </label>
                        </div>

                        <button type="submit" class="col-span-1 md:col-span-3 bg-green-600 text-white py-2 rounded hover:bg-green-700 transition">Cadastrar Membro</button>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-6 py-3">Nome</th>
                                <th class="px-6 py-3">Telefone</th>
                                <th class="px-6 py-3">Bairro</th>
                                <th class="px-6 py-3 text-center">Rhema</th>
                                <th class="px-6 py-3 text-center">Aniversário</th>
                            </tr>
                        </thead>
                        <tbody id="lista-membros">
                            </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <script>
        // CONFIGURAÇÃO SUPABASE
        const SUPABASE_URL = 'https://nekbbkenxcukoortusge.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5la2Jia2VueGN1a29vcnR1c2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTU5MDIsImV4cCI6MjA3ODk3MTkwMn0.D72914Vyz1du1ZDKoNDdwT7YI-D8WPgZe38LbBV2bfc';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // NAVEGAÇÃO
        function showSection(sectionId) {
            ['dashboard', 'cultos', 'membros'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
                document.getElementById('btn-' + id).classList.remove('active-tab');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            document.getElementById('btn-' + sectionId).classList.add('active-tab');
            
            // Recarregar dados específicos
            if(sectionId === 'dashboard') carregarDashboard();
            if(sectionId === 'cultos') carregarCultos();
            if(sectionId === 'membros') carregarMembros();
        }

        // --- BUSCA CEP INTELIGENTE ---
        async function buscarCEP(cep) {
            cep = cep.replace(/\D/g, '');
            if (cep.length === 8) {
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    if (!data.erro) {
                        document.getElementById('m-endereco').value = data.logradouro;
                        document.getElementById('m-bairro').value = data.bairro;
                        document.getElementById('m-cidade').value = data.localidade;
                        document.getElementById('m-uf').value = data.uf;
                        document.getElementById('m-numero').focus();
                    } else {
                        alert("CEP não encontrado.");
                    }
                } catch (e) {
                    console.error("Erro ao buscar CEP", e);
                }
            }
        }

        // --- FUNÇÕES DE MEMBROS ---
        document.getElementById('form-membro').addEventListener('submit', async (e) => {
            e.preventDefault();
            const novoMembro = {
                nome: document.getElementById('m-nome').value,
                data_nascimento: document.getElementById('m-nascimento').value,
                telefone: document.getElementById('m-telefone').value,
                cep: document.getElementById('m-cep').value,
                endereco: document.getElementById('m-endereco').value,
                numero: document.getElementById('m-numero').value,
                bairro: document.getElementById('m-bairro').value,
                cidade: document.getElementById('m-cidade').value,
                uf: document.getElementById('m-uf').value,
                fez_rhema: document.getElementById('m-rhema').checked,
                fez_escola_ministros: document.getElementById('m-ministros').checked,
                fez_escola_missoes: document.getElementById('m-missoes').checked
            };

            const { error } = await supabase.from('membros').insert([novoMembro]);
            if (error) alert('Erro ao salvar: ' + error.message);
            else {
                alert('Membro cadastrado com sucesso!');
                e.target.reset();
                carregarMembros();
            }
        });

        async function carregarMembros(filtroMes = null) {
            let query = supabase.from('membros').select('*').order('nome', { ascending: true });
            
            const { data, error } = await query;
            if (error) return console.error(error);

            const tbody = document.getElementById('lista-membros');
            tbody.innerHTML = '';

            let dadosFiltrados = data;
            
            // Filtro Inteligente (Javascript Side) para Aniversariantes
            if (filtroMes !== null) {
                dadosFiltrados = data.filter(m => {
                    const mesNasc = new Date(m.data_nascimento).getMonth() + 1; // getMonth é 0-indexado
                    // Ajuste de fuso horário pode ser necessário dependendo de como salvou, 
                    // mas para data simples (YYYY-MM-DD) geralmente funciona bem.
                    // Uma abordagem mais segura para string 'YYYY-MM-DD':
                    const mesString = parseInt(m.data_nascimento.split('-')[1]);
                    return mesString === filtroMes;
                });
            }

            dadosFiltrados.forEach(m => {
                const dataNasc = m.data_nascimento.split('-').reverse().join('/');
                const html = `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">${m.nome}</td>
                        <td class="px-6 py-4">${m.telefone || '-'}</td>
                        <td class="px-6 py-4">${m.bairro || '-'}</td>
                        <td class="px-6 py-4 text-center">
                            ${m.fez_rhema ? '<span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded">Sim</span>' : '<span class="text-gray-300">-</span>'}
                        </td>
                        <td class="px-6 py-4 text-center">${dataNasc}</td>
                    </tr>
                `;
                tbody.innerHTML += html;
            });
        }

        function filtrarAniversariantes() {
            const mesAtual = new Date().getMonth() + 1;
            carregarMembros(mesAtual);
            alert(`Filtrando aniversariantes do mês ${mesAtual}`);
        }

        // --- FUNÇÕES DE CULTOS ---
        document.getElementById('form-culto').addEventListener('submit', async (e) => {
            e.preventDefault();
            const novoCulto = {
                data_culto: document.getElementById('c-data').value,
                horario_inicio: document.getElementById('c-inicio').value,
                horario_termino: document.getElementById('c-fim').value,
                ministro: document.getElementById('c-ministro').value,
                dirigente: document.getElementById('c-dirigente').value,
                tempo_ministracao: document.getElementById('c-tempo-min').value,
                tempo_dirigente: document.getElementById('c-tempo-dir').value,
                qtd_homens: parseInt(document.getElementById('c-homens').value) || 0,
                qtd_mulheres: parseInt(document.getElementById('c-mulheres').value) || 0,
                qtd_criancas: parseInt(document.getElementById('c-criancas').value) || 0
            };

            const { error } = await supabase.from('cultos').insert([novoCulto]);
            if (error) alert('Erro ao salvar: ' + error.message);
            else {
                alert('Relatório de culto salvo!');
                e.target.reset();
                carregarCultos();
            }
        });

        async function carregarCultos() {
            const { data, error } = await supabase.from('cultos').select('*').order('data_culto', { ascending: false });
            if (error) return console.error(error);

            const tbody = document.getElementById('lista-cultos');
            tbody.innerHTML = '';

            data.forEach(c => {
                const total = (c.qtd_homens || 0) + (c.qtd_mulheres || 0) + (c.qtd_criancas || 0);
                const dataF = c.data_culto.split('-').reverse().join('/');
                
                const html = `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">${dataF}</td>
                        <td class="px-6 py-4">${c.ministro}</td>
                        <td class="px-6 py-4"><span class="font-bold text-blue-600">${total}</span> pessoas</td>
                        <td class="px-6 py-4">${c.tempo_ministracao || 0} min</td>
                    </tr>
                `;
                tbody.innerHTML += html;
            });
        }

        // --- DASHBOARD E ANALYTICS ---
        let chartFreqInstancia = null;
        let chartDemoInstancia = null;

        async function carregarDashboard() {
            // Carregar dados de Membros
            const { data: membros } = await supabase.from('membros').select('*');
            const totalMembros = membros.length;
            const graduadosRhema = membros.filter(m => m.fez_rhema).length;
            const mesAtual = new Date().getMonth() + 1;
            const aniversariantes = membros.filter(m => parseInt(m.data_nascimento.split('-')[1]) === mesAtual).length;

            document.getElementById('dash-total-membros').innerText = totalMembros;
            document.getElementById('dash-rhema').innerText = graduadosRhema;
            document.getElementById('dash-aniversariantes').innerText = aniversariantes;

            // Carregar dados de Cultos
            const { data: cultos } = await supabase.from('cultos').select('*').order('data_culto', { ascending: true }); // Ascendente para gráfico cronológico
            
            // Calculos
            let totalPublicoGeral = 0;
            let totalHomens = 0, totalMulheres = 0, totalCriancas = 0;
            const labelsDatas = [];
            const dataPublico = [];

            cultos.forEach(c => {
                const totalCulto = (c.qtd_homens || 0) + (c.qtd_mulheres || 0) + (c.qtd_criancas || 0);
                totalPublicoGeral += totalCulto;
                totalHomens += (c.qtd_homens || 0);
                totalMulheres += (c.qtd_mulheres || 0);
                totalCriancas += (c.qtd_criancas || 0);

                // Prepara dados para gráfico (últimos 10 cultos)
                labelsDatas.push(c.data_culto.split('-').reverse().slice(0,2).join('/')); // DD/MM
                dataPublico.push(totalCulto);
            });

            const mediaPublico = cultos.length > 0 ? Math.round(totalPublicoGeral / cultos.length) : 0;
            document.getElementById('dash-media-publico').innerText = mediaPublico;

            // --- RENDERIZAR GRÁFICOS ---
            
            // 1. Gráfico de Frequência (Linha)
            const ctxFreq = document.getElementById('chartFrequencia').getContext('2d');
            if(chartFreqInstancia) chartFreqInstancia.destroy();
            
            chartFreqInstancia = new Chart(ctxFreq, {
                type: 'line',
                data: {
                    labels: labelsDatas.slice(-10), // Últimos 10
                    datasets: [{
                        label: 'Total de Presentes',
                        data: dataPublico.slice(-10),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true }
            });

            // 2. Gráfico Demográfico (Pizza)
            const ctxDemo = document.getElementById('chartDemografia').getContext('2d');
            if(chartDemoInstancia) chartDemoInstancia.destroy();

            chartDemoInstancia = new Chart(ctxDemo, {
                type: 'doughnut',
                data: {
                    labels: ['Homens', 'Mulheres', 'Crianças'],
                    datasets: [{
                        data: [totalHomens, totalMulheres, totalCriancas],
                        backgroundColor: ['#3b82f6', '#ec4899', '#f59e0b']
                    }]
                },
                options: { responsive: true }
            });
        }

        // Inicializar
        carregarDashboard();

    </script>
</body>
</html>
